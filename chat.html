<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rao‚Äôs Chat X ‚Äî Chat</title>
  <style>
    :root{ --bg:#0b141a; --panel:#111b21; --text:#e9edef; --muted:#8696a0; --brand:#00a884; --me:#005c4b; --them:#1f2c33; --shadow:0 10px 25px rgba(0,0,0,.35)}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto;}
    header{position:sticky;top:0;background:var(--panel);display:flex;gap:10px;align-items:center;padding:8px 12px;z-index:5;box-shadow:0 2px 0 rgba(0,0,0,.2)}
    .avatar{width:36px;height:36px;border-radius:50%;background:#0e1a20 center/cover no-repeat}
    .name{font-weight:800}
    .sub{font-size:12px;color:var(--muted)}
    .menu{margin-left:auto;display:flex;gap:8px}
    .btn{padding:8px 10px;border-radius:10px;border:1px solid #1f2c33;background:#162027;color:var(--text);cursor:pointer}
    .msgs{padding:10px; display:flex; flex-direction:column; gap:6px; min-height: calc(100dvh - 160px)}
    .bubble{max-width:78%; padding:10px 12px; border-radius:16px; box-shadow:0 1px 0 rgba(0,0,0,.2); position:relative}
    .me{align-self:flex-end; background:var(--me)}
    .them{align-self:flex-start; background:var(--them)}
    .time{font-size:11px; color:#cbd5e1; margin-left:8px}
    .reacts{position:absolute; bottom:-14px; right:10px; font-size:14px}
    .composer{position:sticky; bottom:0; background:var(--panel); display:flex; gap:8px; padding:8px; align-items:center}
    input[type=text]{flex:1; padding:12px; border-radius:999px; border:1px solid #233138; background:#0e1a20; color:var(--text)}
    .send{padding:10px 14px; border-radius:999px; background:var(--brand); color:#032d23; font-weight:900; border:0}
    .typing{padding:6px 12px; font-size:12px; color:var(--muted)}
    .context{position:fixed; display:none; background:#000; color:#fff; padding:6px 8px; border-radius:10px; z-index:20}
    .reactions{display:flex; gap:6px}
  </style>
</head>
<body>
  <header>
    <div class="avatar" id="av"></div>
    <div>
      <div class="name" id="nm"></div>
      <div class="sub" id="status">‚Ä¶</div>
    </div>
    <div class="menu">
      <button class="btn" id="toggleTheme">Dark/Light</button>
      <button class="btn" id="blockBtn">Block</button>
      <button class="btn" id="reportBtn">Report</button>
    </div>
  </header>

  <div class="typing" id="typing" style="display:none"></div>
  <div class="msgs" id="msgs"></div>

  <div class="composer">
    <input id="msg" type="text" placeholder="Type a message" />
    <button class="send" id="send">Send</button>
  </div>

  <div class="context" id="ctxMenu">
    <div class="reactions">
      <button>üëç</button><button>‚ù§Ô∏è</button><button>üòÇ</button><button>üòÆ</button><button>üò¢</button><button>üî•</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig= { apiKey: "AIzaSyAJHqq9T9d5zbHoCumvNt9AK1L2fusa8Gk", authDomain: "wbapp-ff0f2.firebaseapp.com", projectId: "wbapp-ff0f2", storageBucket: "wbapp-ff0f2.firebasestorage.app", messagingSenderId: "580773775966", appId: "1:580773775966:web:d851d41c2091257a2d42cf" };
    const app= initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const params = new URLSearchParams(location.search);
    let other = (params.get('with')||'').toLowerCase();
    const myUsername = localStorage.getItem('rx_username');
    if(!other){ alert('Missing ?with=username'); location.href='home.html'; }

    function toggleTheme(){ const cur=localStorage.getItem('rx_theme')||'dark'; localStorage.setItem('rx_theme', cur==='dark'?'light':'dark'); location.reload(); }
    function applyTheme(){ const t=localStorage.getItem('rx_theme')||'dark'; if(t==='light'){ document.documentElement.style.setProperty('--bg','#f0f2f5'); document.documentElement.style.setProperty('--panel','#ffffff'); document.documentElement.style.setProperty('--text','#111'); document.documentElement.style.setProperty('--muted','#556'); document.documentElement.style.setProperty('--me','#d9fdd3'); document.documentElement.style.setProperty('--them','#ffffff'); } }
    applyTheme();
    document.getElementById('toggleTheme').onclick = toggleTheme;

    const av = document.getElementById('av');
    const nm = document.getElementById('nm');
    const status = document.getElementById('status');
    const typingEl = document.getElementById('typing');
    const msgsEl = document.getElementById('msgs');
    const input = document.getElementById('msg');

    // Notifications (when tab active)
    if('Notification' in window && Notification.permission==='default'){ Notification.requestPermission(); }

    const users = [myUsername, other].sort();
    const chatId = users.join('_');
    const chatRef = doc(db,'Chats', chatId);

    // Ensure chat doc exists
    (async()=>{ const c=await getDoc(chatRef); if(!c.exists()){ await setDoc(chatRef,{ users, lastMessage:'', lastMessageTime:new Date().toISOString(), typing:{}}); } })();

    // Load other profile
    (async()=>{
      const d = await getDoc(doc(db,'Users', other));
      if(d.exists()){
        const u=d.data(); av.style.backgroundImage=`url('${u.avatar}')`; nm.innerHTML = `${u.name||other} ${u.verified?'<span title="Verified" style="color:#1DA1F2">‚úì</span>':''}`;
        const last = new Date(u.lastSeen||0);
        const online = (Date.now()-last.getTime())<60000; status.textContent = online? 'Online' : `last seen ${last.toLocaleString()}`;
      } else { nm.textContent = other; }
    })();

    // Block button
    document.getElementById('blockBtn').onclick = async()=>{
      const meRef = doc(db,'Users', myUsername);
      const me = await getDoc(meRef);
      const list = me.exists() ? (me.data().blockedUsers||[]) : [];
      if(list.includes(other)) { alert('Already blocked'); return; }
      list.push(other);
      await updateDoc(meRef, { blockedUsers: list });
      alert('User blocked');
    };

    // Report button
    document.getElementById('reportBtn').onclick = async()=>{
      const reason = prompt('Reason for report?'); if(!reason) return;
      await addDoc(collection(db,'Reports'), { reporter: myUsername, reportedUser: other, reason, time: new Date().toISOString() });
      alert('Report submitted');
    };

    // Typing indicator handling
    let typingTimer;
    input.addEventListener('input', async()=>{
      clearTimeout(typingTimer);
      await updateDoc(chatRef, { [`typing.${myUsername}`]: true });
      typingTimer = setTimeout(async()=>{ try{ await updateDoc(chatRef, { [`typing.${myUsername}`]: false }); }catch{} }, 1000);
    });

    onSnapshot(chatRef, (snap)=>{
      const d=snap.data(); if(!d) return; const t=d.typing||{}; typingEl.style.display = t[other]? 'block':'none'; typingEl.textContent = `${other} is typing‚Ä¶`;
    });

    // Messages subcollection
    const msgsQ = query(collection(db,'Chats', chatId, 'messages'), orderBy('time'));
    onSnapshot(msgsQ, (snapshot)=>{
      msgsEl.innerHTML='';
      snapshot.forEach(docSnap=>{
        const m = docSnap.data();
        const isMe = m.sender===myUsername;
        const div = document.createElement('div'); div.className = `bubble ${isMe?'me':'them'}`; div.textContent = m.text; 
        const time = document.createElement('span'); time.className='time'; time.textContent = new Date(m.time?.toDate?.()?m.time.toDate():m.time||Date.now()).toLocaleTimeString(); div.appendChild(time);
        const reacts = document.createElement('div'); reacts.className='reacts'; reacts.textContent = m.reactions? Object.values(m.reactions).join(' '):''; div.appendChild(reacts);
        div.dataset.id = docSnap.id;

        // Long press / context menu for reactions
        let pressTimer;
        const showMenu=(x,y)=>{ const ctx=document.getElementById('ctxMenu'); ctx.style.left=x+'px'; ctx.style.top=y+'px'; ctx.style.display='block'; ctx.dataset.msgId = docSnap.id; };
        const hideMenu=()=>{ document.getElementById('ctxMenu').style.display='none'; };
        div.addEventListener('contextmenu', (e)=>{ e.preventDefault(); showMenu(e.pageX, e.pageY); });
        div.addEventListener('touchstart', (e)=>{ pressTimer=setTimeout(()=>{ const t=e.touches[0]; showMenu(t.pageX, t.pageY); }, 500); });
        div.addEventListener('touchend', ()=> clearTimeout(pressTimer));
        document.addEventListener('click', (e)=>{ if(e.target.closest('#ctxMenu')) return; hideMenu(); });

        msgsEl.appendChild(div);
        msgsEl.scrollTop = msgsEl.scrollHeight;

        // Notify when receiving
        if('Notification' in window && document.hidden && !isMe){ try{ new Notification(`New message from ${other}`, { body: m.text }); }catch{} }
      });
    });

    document.getElementById('ctxMenu').addEventListener('click', async(e)=>{
      if(e.target.tagName!=='BUTTON') return; const emoji=e.target.textContent; const id = e.currentTarget.dataset.msgId; if(!id) return;
      const { updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
      await updateDoc(doc(db,'Chats', chatId, 'messages', id), { [`reactions.${myUsername}`]: emoji });
      e.currentTarget.style.display='none';
    });

    // Send
    document.getElementById('send').addEventListener('click', send);
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ send(); } });

    async function send(){
      const text = input.value.trim(); if(!text) return;
      // block checks
      const me = await getDoc(doc(db,'Users', myUsername));
      const he = await getDoc(doc(db,'Users', other));
      const myBlocked = me.exists()? (me.data().blockedUsers||[]) : [];
      const hisBlocked = he.exists()? (he.data().blockedUsers||[]) : [];
      if(myBlocked.includes(other)) return alert('You have blocked this user. Unblock from profile to send messages.');
      if(hisBlocked.includes(myUsername)) return alert('You are blocked by this user.');

      const now = serverTimestamp();
      await addDoc(collection(db,'Chats', chatId, 'messages'), { sender: myUsername, text, time: now });
      await updateDoc(chatRef, { lastMessage: text, lastMessageTime: new Date().toISOString() });
      input.value='';
    }

    // Presence heartbeat for me
    onAuthStateChanged(auth, async(user)=>{
      if(!user){ location.href='index.html'; return; }
      setInterval(async()=>{ try{ await updateDoc(doc(db,'Users', myUsername), { online:true, lastSeen:new Date().toISOString() }); }catch{} }, 30000);
    });
  </script>
</body>
</html>